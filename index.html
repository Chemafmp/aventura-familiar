document.addEventListener("DOMContentLoaded", function () {
  let personaje = "";
  let puntos = parseInt(localStorage.getItem("puntos")) || 0;

  const historia = {
    inicio: {
      texto: "Despiertas en tu habitaciÃ³n y notas que algo no estÃ¡ bien... los elfos han desaparecido. Â¿QuÃ© haces?",
      opciones: [
        { texto: "Buscar en el armario", siguiente: "armario" },
        { texto: "Ir al salÃ³n", siguiente: "salon" }
      ]
    },
    armario: {
      texto: "Abres el armario y encuentras una nota: 'Ven al mundo mÃ¡gico'. Â¿Vas?",
      opciones: [
        { texto: "Â¡SÃ­, vamos!", siguiente: "mundoMagico" },
        { texto: "No, da miedo...", siguiente: "finMiedo" }
      ]
    },
    salon: {
      texto: "En el salÃ³n, solo hay silencio... hasta que algo se mueve detrÃ¡s del sofÃ¡.",
      opciones: [
        { texto: "Investigar detrÃ¡s del sofÃ¡", siguiente: "sofa" },
        { texto: "Volver a la habitaciÃ³n", siguiente: "inicio" }
      ]
    },
    mundoMagico: {
      texto: "Â¡Has entrado en el mundo mÃ¡gico! AquÃ­ empieza tu gran aventura...",
      opciones: []
    },
    finMiedo: {
      texto: "Te escondes bajo las mantas. Tal vez otro dÃ­a... Fin.",
      opciones: []
    },
    sofa: {
      texto: "Â¡Sorpresa! Los elfos te estaban esperando para jugar. Â¡Comienza la aventura!",
      opciones: []
    }
  };

  const puntosEl = document.getElementById("contador-puntos");
  const reiniciarBtn = document.getElementById("boton-reiniciar");
  const listaLogros = document.getElementById("lista-logros");

  function actualizarPuntosUI() {
    puntosEl.textContent = `Puntos: ${puntos}`;
  }

  function agregarLogro(texto) {
    const item = document.createElement("li");
    item.textContent = texto;
    listaLogros.appendChild(item);
  }

  function elegirPersonaje(nombre) {
    personaje = nombre;
    localStorage.setItem("personaje", personaje);
    localStorage.setItem("puntos", 0);
    puntos = 0;
    document.getElementById("pantalla-inicio").classList.add("hidden");
    document.getElementById("pantalla-historia").classList.remove("hidden");
    document.getElementById("nombre-personaje").textContent = `ðŸ‘¤ Personaje: ${personaje}`;
    actualizarPuntosUI();
    mostrarEscena("inicio");
  }

  function mostrarEscena(escena) {
    const nodo = historia[escena];
    localStorage.setItem("escena", escena);
    document.getElementById("texto-historia").textContent = nodo.texto;
    const contenedorOpciones = document.getElementById("opciones");
    contenedorOpciones.innerHTML = "";

    nodo.opciones.forEach(op => {
      const btn = document.createElement("button");
      btn.textContent = op.texto;
      btn.onclick = () => {
        puntos += 10;
        localStorage.setItem("puntos", puntos);
        actualizarPuntosUI();
        mostrarEscena(op.siguiente);
      };
      contenedorOpciones.appendChild(btn);
    });

    if (nodo.opciones.length === 0) {
      puntos += 50;
      localStorage.setItem("puntos", puntos);
      actualizarPuntosUI();
      agregarLogro("ðŸ Aventura completada");
    }
  }

  reiniciarBtn.addEventListener("click", () => {
    localStorage.clear();
    location.reload();
  });

  // Restaurar progreso si existe
  const personajeGuardado = localStorage.getItem("personaje");
  const escenaGuardada = localStorage.getItem("escena");
  if (personajeGuardado && escenaGuardada) {
    personaje = personajeGuardado;
    document.getElementById("pantalla-inicio").classList.add("hidden");
    document.getElementById("pantalla-historia").classList.remove("hidden");
    document.getElementById("nombre-personaje").textContent = `ðŸ‘¤ Personaje: ${personaje}`;
    actualizarPuntosUI();
    mostrarEscena(escenaGuardada);
  }

  // Hacer disponible globalmente
  window.elegirPersonaje = elegirPersonaje;
});